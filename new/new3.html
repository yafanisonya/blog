<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>异步编程 | Fanison&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    
    <meta name="description" content="Keep Learning, Keep Growing, Keep Succeeding">
    
    <link rel="preload" href="/blog/assets/css/0.styles.b6bfb1ac.css" as="style"><link rel="preload" href="/blog/assets/js/app.4c32c465.js" as="script"><link rel="preload" href="/blog/assets/js/2.54c8166e.js" as="script"><link rel="preload" href="/blog/assets/js/22.1e9a7797.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.f629a381.js"><link rel="prefetch" href="/blog/assets/js/11.62d89ebc.js"><link rel="prefetch" href="/blog/assets/js/12.82db1fc0.js"><link rel="prefetch" href="/blog/assets/js/13.96eea11c.js"><link rel="prefetch" href="/blog/assets/js/14.da967776.js"><link rel="prefetch" href="/blog/assets/js/15.585e091a.js"><link rel="prefetch" href="/blog/assets/js/16.89ae9827.js"><link rel="prefetch" href="/blog/assets/js/17.53815d8e.js"><link rel="prefetch" href="/blog/assets/js/18.f829032d.js"><link rel="prefetch" href="/blog/assets/js/19.7db81cc4.js"><link rel="prefetch" href="/blog/assets/js/20.c6418096.js"><link rel="prefetch" href="/blog/assets/js/21.49e7d6a6.js"><link rel="prefetch" href="/blog/assets/js/23.6f28dbc4.js"><link rel="prefetch" href="/blog/assets/js/24.210ec04e.js"><link rel="prefetch" href="/blog/assets/js/25.3a5b3b3a.js"><link rel="prefetch" href="/blog/assets/js/26.5e36d150.js"><link rel="prefetch" href="/blog/assets/js/3.5fcfdba5.js"><link rel="prefetch" href="/blog/assets/js/4.9f593b04.js"><link rel="prefetch" href="/blog/assets/js/5.b610c8cf.js"><link rel="prefetch" href="/blog/assets/js/6.7b1f2309.js"><link rel="prefetch" href="/blog/assets/js/7.369fe853.js"><link rel="prefetch" href="/blog/assets/js/8.fca4ae6a.js"><link rel="prefetch" href="/blog/assets/js/9.319239bc.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.b6bfb1ac.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Fanison's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目总结" class="dropdown-title"><span class="title">项目总结</span> <span class="arrow down"></span></button> <button type="button" aria-label="项目总结" class="mobile-dropdown-title"><span class="title">项目总结</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/project/" class="nav-link">
  Vue3 Wheel
</a></li><li class="dropdown-item"><!----> <a href="/blog/project/morney.html" class="nav-link">
  React Money
</a></li><li class="dropdown-item"><!----> <a href="https://yafanisonya.github.io/note/money/note.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue Money
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://yafanisonya.github.io/note/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  学习笔记
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/yafanisonya" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目总结" class="dropdown-title"><span class="title">项目总结</span> <span class="arrow down"></span></button> <button type="button" aria-label="项目总结" class="mobile-dropdown-title"><span class="title">项目总结</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/project/" class="nav-link">
  Vue3 Wheel
</a></li><li class="dropdown-item"><!----> <a href="/blog/project/morney.html" class="nav-link">
  React Money
</a></li><li class="dropdown-item"><!----> <a href="https://yafanisonya.github.io/note/money/note.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue Money
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://yafanisonya.github.io/note/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  学习笔记
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/yafanisonya" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Home</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/" aria-current="page" class="sidebar-link">Home</a></li><li><a href="/blog/cv/" class="sidebar-link">简历</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/frontend/" class="sidebar-link">手写代码</a></li><li><a href="/blog/frontend/fr002.html" class="sidebar-link">JS进阶</a></li><li><a href="/blog/frontend/fr003.html" class="sidebar-link">JS 基础</a></li><li><a href="/blog/frontend/fr004.html" class="sidebar-link">HTML、CSS、DOM</a></li><li><a href="/blog/frontend/typescript.html" class="sidebar-link">TypeScript</a></li><li><a href="/blog/frontend/webpack.html" class="sidebar-link">Webpack</a></li><li><a href="/blog/frontend/browser.html" class="sidebar-link">浏览器</a></li><li><a href="/blog/frontend/network.html" class="sidebar-link">网络</a></li><li><a href="/blog/frontend/safety.html" class="sidebar-link">安全</a></li><li><a href="/blog/frontend/vue.html" class="sidebar-link">Vue</a></li><li><a href="/blog/frontend/react.html" class="sidebar-link">React</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>深入浅出</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/new/new1.html" class="sidebar-link">服务端渲染</a></li><li><a href="/blog/new/new2.html" class="sidebar-link">函数式编程</a></li><li><a href="/blog/new/new3.html" aria-current="page" class="active sidebar-link">异步编程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/new/new4.html" class="sidebar-link">TypeScript</a></li><li><a href="/blog/new/new5.html" class="sidebar-link">Vuex 状态管理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>项目总结</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/project/" class="sidebar-link">Vue3 Wheel</a></li><li><a href="/blog/project/morney.html" class="sidebar-link">React Money</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="异步编程"><a href="#异步编程" class="header-anchor">#</a> 异步编程</h3> <h4 id="同步模式"><a href="#同步模式" class="header-anchor">#</a> 同步模式</h4> <div class="language- extra-class"><pre class="language-text"><code>console.log('global start')

function bar(){
  console.log('bar task')
}

function foo(){
  console.log('foo task')
  bar()
}

foo()

console.log('global end')

// 输出
global begin
foo task
bar task
global end
</code></pre></div><h4 id="异步模式"><a href="#异步模式" class="header-anchor">#</a> 异步模式</h4> <p><img src="https://i.imgur.com/KEeOg6m.png" alt="异步模式"></p> <div class="language- extra-class"><pre class="language-text"><code>console.log('global begin')

setTimeout(function timer1(){
  console.log('timer1 invoke')
},1800)

setTimeout(function timer2(){
  console.log('timer2 invoke')

  setTimeout(function inner(){
    console.log('inner invoke')
  },1000)
})

console.log('global end')

// 输出
global begin
global end
timer2 invoke
timer1 invoke
inner invoke
</code></pre></div><h4 id="回调函数"><a href="#回调函数" class="header-anchor">#</a> 回调函数</h4> <div class="language- extra-class"><pre class="language-text"><code>function foo(callback){
  setTimeout(function(){
    callback()
  },3000)
}

foo(function(){
  console.log('回调函数')
  console.log('异步任务结束后执行此函数')
})
</code></pre></div><h4 id="promise"><a href="#promise" class="header-anchor">#</a> Promise</h4> <p><img src="https://i.imgur.com/FRD0dFV.png" alt="Promise"></p> <h5 id="基本示例"><a href="#基本示例" class="header-anchor">#</a> 基本示例</h5> <div class="language- extra-class"><pre class="language-text"><code>const promise = new Promise(function (reslove, reject){
  resolve(100)
  reject(new Error('promise rejected'))
})

promise.then(function (value){
  console.log('resolved ===&gt;&gt;&gt; ', value)
}, function (error){
  console.log('rejected ===&gt;&gt;&gt;', error)
})
</code></pre></div><h5 id="封装-ajax"><a href="#封装-ajax" class="header-anchor">#</a> 封装 AJAX</h5> <div class="language- extra-class"><pre class="language-text"><code>function ajax(url){
  return new Promise(function (resolve, reject) {
    var xhr = new XMLHttpRequest()
    xhr.open('GET',url)
    xhr.responseType = 'json'
    xhr.onload = function (){
      if(this.status === 200){
        resolve(this.response)
      } else {
        reject(new Error(this.statusText))
      }
    }
    xhr.send()
  })
}

ajax('/api/first.json').then( function (res){
  console.log(res)
}, function (error){
  console.log(error)
})
</code></pre></div><h5 id="链式调用"><a href="#链式调用" class="header-anchor">#</a> 链式调用</h5> <div class="language- extra-class"><pre class="language-text"><code>ajax('/api/users.json')
  .then(function(value){
    console.log('first === &gt;&gt;&gt;')
  })
  .then(function(value){
    console.log('second === &gt;&gt;&gt;')
  })
</code></pre></div><h5 id="异常处理"><a href="#异常处理" class="header-anchor">#</a> 异常处理</h5> <div class="language- extra-class"><pre class="language-text"><code>// 因为 Promise 链条上的任何一个异常都会被一直向后传递，直至捕获
// 分开注册的 onRejected 相当于给整个 Promise 链条注册失败回调

ajax('/api/users.json')
  .then(function onFulfilled(value){
    console.log('onFulfilled === &gt;&gt;&gt;', value)
  })
  .catch(function onRejected(error){
    console.log('onRejected === &gt;&gt;&gt;', error)
  })

 // then(onRejected) 实际上就相当于 then(undefined, onRejected)

  ajax('/api/users.json')
    .then(function onFulfilled(value){
      console.log('onFulfilled === &gt;&gt;&gt;', value)
    })
    .then(undefined, function onRejected(error){
      console.log('onRejected === &gt;&gt;&gt;', error)
    })

 // 同时注册的 onRejected 只是给当前 Promise 对象注册的失败回调， 它只能捕获到当前 Promise 对象的异常

  ajax('/api/users.json')
    .then(function onFulfilled(value){
      console.log('onFulfilled === &gt;&gt;&gt;', value)
    }, function onRejected(error){
      console.log('onRejected === &gt;&gt;&gt;', error)
    })
</code></pre></div><h5 id="all、race"><a href="#all、race" class="header-anchor">#</a> All、Race</h5> <ul><li>Promise.all()中的 Promise 全部执行通过才认为是成功，否则认为是失败；</li> <li>Promise.race()中的 Promise 中第一个执行完毕的是通过，则认为成功，如果第一个执行完毕的 Promise 是拒绝，则认为失败；</li></ul> <div class="language- extra-class"><pre class="language-text"><code>var promise = Promise.all([
  ajax('/api/users.json'),
  ajax('/api/posts.json')
])

// Promise.race 实现超时控制
const request = ajax('/api/posts.json')
const timeout = new Promise((resolve, reject) =&gt; {
  setTimeout(() =&gt; reject(new Error('timeout === &gt;&gt;&gt;')), 500)
})

Promise.race([
  request, timeout
])
.then(value =&gt;{
  console.log(value)
})
.catch(error =&gt;{
  console.log(error)
})
</code></pre></div><h5 id="执行顺序"><a href="#执行顺序" class="header-anchor">#</a> 执行顺序</h5> <div class="language- extra-class"><pre class="language-text"><code>// 微任务
console.log('global start')

// setTimeout 的回调是 宏任务， 进入回调队列排队
setTimeout(() =&gt; {
  console.log('setTimeout')
}, 0)

// Promise 的回调是 微任务， 本轮调用末尾直接执行
Promise.resolve()
  .then(() =&gt; {
    console.log('promise')
  }）
  .then(() =&gt; {
    console.log('promise 2')
  })
  .then(() =&gt; {
    console.log('promise 3')
  })

console.log('global end')

// 输出
// global start, global end, promise, promise 2, promise 3, setTimeout
</code></pre></div><h4 id="generator"><a href="#generator" class="header-anchor">#</a> Generator</h4> <ul><li>Generator 函数可以暂停执行， 在函数名前要加星号</li> <li>value 是 yield 语句后面表达式的值，表示当前阶段的值；</li> <li>done 是布尔值，表示 Generator 函数是否执行完毕，即是否还有下一个阶段</li></ul> <div class="language- extra-class"><pre class="language-text"><code>// 生成器函数
function * foo(){
  console.log('start === &gt;&gt;&gt;')

  try{
    const res = yield 'foo'
    console.log(res)
  } catch(e){
    console.log(e)
  }
}

// 执行函数不会返回结果，返回的是指针对象
const generator = foo()

// 调用指针的 next 方法，会移动内部指针指向第一个 yield 语句
const result = generator.next()
console.log(result)  //  { value: 'foo', done: false }

// next方法带有参数，参数传入 Generator 函数，作为上个阶段异步任务的返回结果
generator.next('bar') // bar

// 使用指针对象的 throw 方法抛出错误， 可以被 try...catch 代码块捕获
generator.throw(new Error('Generator error'))
</code></pre></div><h4 id="async、await"><a href="#async、await" class="header-anchor">#</a> Async、Await</h4> <ul><li>async 函数返回一个 Promise 对象，可以使用 then 方法添加回调函数</li> <li>当函数执行时，一旦遇到 await 就会先返回</li> <li>等到触发的异步操作完成，再执行函数体内后面的语句</li> <li>await 命令只能用在 async 函数之中，如果用在普通函数，就会报错</li></ul> <div class="language- extra-class"><pre class="language-text"><code>async function main(){
  try{
    const users = await ajax('/api/users.json')
    console.log(users)

    const posts = await ajax('/api/posts.json')
    console.log(posts)

    const urls = await ajax('/api/urls.json')
    console.log(urls)
  } catch (e) {
    console.log(e)
  }
}

const promise = main()

promise.then(() =&gt; {
  console.log('all completed')
})
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/new/new2.html" class="prev">
        函数式编程
      </a></span> <span class="next"><a href="/blog/new/new4.html">
        TypeScript
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.4c32c465.js" defer></script><script src="/blog/assets/js/2.54c8166e.js" defer></script><script src="/blog/assets/js/22.1e9a7797.js" defer></script>
  </body>
</html>
